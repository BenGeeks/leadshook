<!-- MAIN -->
<script>
  const messageKey = 'ZR4wUggoGkXjRqlcTrYKFFXpNGyVcXJwmYl0aBw3';
  let messageID, confirmed;
  let parentGtmEnabled = true;

  const sendMessage = (eventData) => {
    let sendInterval = setInterval(() => {
      confirmed ? clearInterval(sendInterval) : parent.postMessage(eventData, '*');
    }, 1000);
  };

  const ga4 = (eventName, data) => {
    confirmed = false;
    messageID = Math.floor(Math.random() * 100000000);
    const eventData = { messageKey, messageID, eventName, eventData: data };
    parentGtmEnabled && sendMessage(eventData);
  };

  window.addEventListener('message', (message) => message.data === messageID && (confirmed = true), false);
</script>

<!-- GTM GA4 event listener -->
<script>
  var dataLayer = window.dataLayer || (window.dataLayer = []);

  function sendResponse(messageID) {
    event.source.postMessage(messageID, '*');
  }

  function receiveMessage(message) {
    if (message.data.messageKey === 'ZR4wUggoGkXjRqlcTrYKFFXpNGyVcXJwmYl0aBw3') {
      console.log('Event from LeadsHook received: ', message.data.eventName);
      sendResponse(message.data.messageID);
      dataLayer.push({
        event: 'LH_' + message.data.eventName,
        leadsHook_data: message.data.eventData,
      });
    }
  }

  window.addEventListener('message', receiveMessage, false);
</script>

<!-- First Visit -->
<script>
  let leadInfo = {
    leadID: '{lead_id}',
    leadToken: '{lead_token}',
    createdOn: '{lead_created}',
    userAgent: '{_c_useragent}',
  };
  let eventInfo = {
    eventID: '{_c_eventid}',
    eventTime: '{_c_eventtime}',
    eventURL: '{_c_eventurl}',
  };
  let decisionTreeInfo = {
    embedURL: '{_c_embedurl}',
    decisionTree: '{_c_dt}',
    decisionTreeVersion: '{_c_dt_ver}',
  };
  console.log(leadInfo);
  console.log(eventInfo);
  console.log(decisionTreeInfo);
  ga4('first_visit', { leadInfo, eventInfo, decisionTreeInfo });
</script>

<!-- Page View -->
<script>
  let eventName = '{_c_identifier}' ? 'view_{_c_identifier}' : 'page_view';
  ga4(eventName, {
    eventID: '{_c_eventid}',
    eventTime: '{_c_eventtime}',
    nodeTitle: '{_c_node}',
    nodeIdentifier: '{_c_identifier}',
    eventQuestion: '{_c_question}',
    eventAnswer: '{_c_answer}',
  });
</script>

<!-- Question and Answer -->
<script>
  let eventName = '{_c_identifier}' ? 'q&a_{_c_identifier}' : 'q&a_event';
  ga4(eventName, {
    eventID: '{_c_eventid}',
    eventTime: '{_c_eventtime}',
    nodeTitle: '{_c_node}',
    nodeIdentifier: '{_c_identifier}',
    eventQuestion: '{_c_question}',
    eventAnswer: '{_c_answer}',
  });
</script>

<!-- Form Node -->
<script>
  setTimeout(() => {
    let eventName = '{_c_identifier}' ? 'form_{_c_identifier}' : 'form_event';
    let formGroup = document.getElementsByClassName('form-group');
    let btn = document.getElementsByClassName('btn')[0];
    const getData = () => {
      let formData = {};
      for (let i = 0; i < formGroup.length; i++) {
        let key = formGroup[i].getElementsByTagName('LABEL')[0].firstElementChild.innerHTML;
        let value = formGroup[i].getElementsByTagName('DIV')[0].getElementsByTagName('INPUT')[0].value;
        formData[key] = value;
      }
      return formData;
    };
    btn.addEventListener('click', () =>
      ga4(eventName, {
        eventID: '{_c_eventid}',
        eventTime: '{_c_eventtime}',
        nodeTitle: '{_c_node}',
        nodeIdentifier: '{_c_identifier}',
        formData: getData(),
      })
    );
  }, 1000);
</script>

<!-- Page View for Result Page-->
<script>
  let eventName = '{_c_identifier}' ? 'completed_{_c_identifier}' : 'completed';
  ga4(eventName, {
    eventID: '{_c_eventid}',
    eventTime: '{_c_eventtime}',
    nodeTitle: '{_c_node}',
    nodeIdentifier: '{_c_identifier}',
  });
</script>

<!-- GTM UA event listener -->
<script>
  var dataLayer = window.dataLayer || (window.dataLayer = []);

  function sendResponse(messageID) {
    event.source.postMessage(messageID, '*');
  }

  function receiveMessage(message) {
    if (message.data.messageKey === 'ZR4wUggoGkXjRqlcTrYKFFXpNGyVcXJwmYl0aBw3') {
      sendResponse(message.data.messageID);

      if (message.data.eventName.includes('first_visit')) {
        dataLayer.push({
          event: 'LH First Visit',
          LH_data: {
            category: 'LH_first_visit',
            action: 'LH_leadID_' + message.data.eventData.leadInfo.leadID,
            label: 'LH_leadToken_' + message.data.eventData.leadInfo.leadToken,
            value: '',
            eventTime: message.data.eventData.eventInfo.eventTime,
            eventID: message.data.eventData.eventInfo.eventID,
          },
        });
      }

      if (message.data.eventName.includes('view')) {
        dataLayer.push({
          event: 'LH Page View',
          LH_data: {
            category: 'LH_page_view',
            action: message.data.eventData.nodeTitle,
            label: message.data.eventData.nodeIdentifier,
            value: '',
            eventTime: message.data.eventData.eventTime,
            eventID: message.data.eventData.eventID,
          },
        });
      }

      if (message.data.eventName.includes('q&a')) {
        dataLayer.push({
          event: 'LH Q&A Event',
          LH_data: {
            category: 'LH_q&a_engagement',
            action: message.data.eventData.nodeTitle,
            label: message.data.eventData.eventQuestion,
            value: message.data.eventData.eventAnswer,
            eventTime: message.data.eventData.eventTime,
            eventID: message.data.eventData.eventID,
          },
        });
      }

      if (message.data.eventName.includes('form')) {
        dataLayer.push({
          event: 'LH Form Event',
          LH_data: {
            category: 'LH_form_engagement',
            action: message.data.eventData.nodeTitle,
            label: message.data.eventName,
            value: message.data.eventData.formData,
            eventTime: message.data.eventData.eventTime,
            eventID: message.data.eventData.eventID,
          },
        });
      }
    }
  }

  window.addEventListener('message', receiveMessage, false);
</script>

<!-- Form Node -->
<script>
  let eventName = '{_c_identifier}' ? 'form_{_c_identifier}' : 'form_event';
  ga4(eventName, {
    eventID: '{_c_eventid}',
    eventTime: '{_c_eventtime}',
    nodeTitle: '{_c_node}',
    nodeIdentifier: '{_c_identifier}',
    formData: '{form_data}',
  });
</script>

<script>
  setTimeout(() => {
    let formGroup = document.getElementsByClassName('form-group');
    for (let i = 0; i < formGroup.length; i++) {
      let target = formGroup[i].getElementsByTagName('DIV')[0].getElementsByTagName('INPUT')[0];
      if (target.name === 'first_name') target.setAttribute('autocomplete', 'on');
    }
  }, 1000);
</script>
